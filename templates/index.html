{% extends "base.html" %}
{% block title %}DSAWebLectures{% endblock %}

{% block styles %}
{% endblock styles %}
{% block content %}
<div id="bg-grid"></div>

<div class="homepage-wrapper">
  <section id="welcome-section">
    <h1>Welcome to <span class="accent">DSALectures</span></h1>
    <small>subject to change</small>
  </section>

  <div id="feed-scroll"></div>

  <div class="chat-input-bar">
    <input id="home-search" type="text" placeholder="Ask or search... (e.g., 'North Avenue to Ayala')" />
    <button class="chat-send-btn" id="chat-send">Search</button>
  </div>
  
</div>
{% endblock content %}

{% block scripts %}
<script>
const searchBar = document.getElementById("home-search");
const feed = document.getElementById("feed-scroll");
const welcome = document.getElementById("welcome-section");
const sendBtn = document.getElementById("chat-send");

/* =========================
   DISPLAY RESULTS (SINGLE RENDERER)
========================= */
function displayResults(data) {
  feed.innerHTML = "";
  welcome.style.display = "none";

  // ROUTE RESULT
  if (data?.kind === "route") {
    feed.innerHTML = `
      <div class="ai-response">
        <strong>Route Found</strong>
        <div class="caption">${data.path.join(" → ")}</div>
        <div class="search-subtitle">
          ${data.stops} Stops • ${data.minutes} min • ${data.meters} meters
        </div>
      </div>
    `;
    feed.scrollTop = feed.scrollHeight;
    return;
  }

  // NORMAL SEARCH
  if (!Array.isArray(data) || data.length === 0) {
    feed.innerHTML = `<div class="ai-response">No posts found matching your search.</div>`;
    return;
  }

  data.forEach(post => {
    feed.innerHTML += `
      <div class="ai-response">
        <strong>${post.title}</strong>
        <div class="caption">${post.caption_html ?? ""}</div>
        <div class="search-subtitle">
          Related Topics: ${post.related_count ?? 0}
          ${post.latest_comment ? " • Latest: " + post.latest_comment : ""}
        </div>
      </div>
    `;
  });

  feed.scrollTop = feed.scrollHeight;
}

/* =========================
   SEARCH HANDLER
========================= */
async function performSearch() {
  const query = searchBar.value.trim();
  if (!query) return;

  // ROUTE SEARCH: "A to B"
  const routeMatch = query.match(/(.+?)\s+to\s+(.+)/i);
  if (routeMatch) {
    try {
      const res = await fetch("/atlas/route", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          src: routeMatch[1].trim(),
          dst: routeMatch[2].trim()
        })
      });

      const data = await res.json();

      displayResults({
        kind: "route",
        path: data.path,
        minutes: data.minutes,
        meters: data.meters,
        stops: data.path.length - 1
      });
    } catch {
      feed.innerHTML = `
        <div class="ai-response">
          <strong>Route Not Found</strong>
          <div class="caption">Invalid stations or no available route.</div>
        </div>
      `;
    }
    return;
  }

  // NORMAL SEARCH
  fetch(`/search_posts?q=${encodeURIComponent(query)}`)
    .then(res => res.json())
    .then(displayResults)
    .catch(() => {
      feed.innerHTML = `<div class="ai-response">Error searching posts.</div>`;
    });
}

/* =========================
   EVENTS
========================= */
searchBar.addEventListener("keydown", e => {
  if (e.key === "Enter") performSearch();
});
sendBtn.addEventListener("click", performSearch);
</script>

{% endblock scripts %}