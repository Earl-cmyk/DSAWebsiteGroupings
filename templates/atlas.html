{% extends "base.html" %}
{% block title %}Electrical Circuit Designer - {{ super() }}{% endblock %}
{% block styles %}
{{ super() }}
<style>
/* =====================
   MAP CONTAINER
===================== */
#atlas-svg {
  background-color: #0b1220;
  user-select: none;
  overflow: hidden;
}

/* =====================
   STATIONS
===================== */
.station {
  fill: #94a3b8;
  stroke: #e5e7eb;
  stroke-width: 2;
  cursor: pointer;
  transition: transform 0.15s ease, fill 0.15s ease;
}

.station:hover {
  fill: #38bdf8;
}

.station.locked {
  fill: #22c55e;
  stroke: #bbf7d0;
  stroke-width: 3;
}

/* =====================
   LABELS
===================== */
.station-label {
  font-size: 11px;
  font-weight: 600;
  fill: #e5e7eb;
  pointer-events: none;
  text-anchor: middle;
  transition: fill 0.15s ease, font-size 0.15s ease;
}

.station.locked + .station-label {
  fill: #facc15;
  font-size: 12px;
}

/* =====================
   LINES
===================== */
.line-mrt3 {
  stroke: #facc15;
  stroke-width: 5;
  stroke-linecap: round;
}

.line-lrt1 {
  stroke: #ef4444;
  stroke-width: 5;
  stroke-linecap: round;
}

.line-lrt2 {
  stroke: #a855f7;
  stroke-width: 5;
  stroke-linecap: round;
}

/* =====================
   ROUTE HIGHLIGHT
===================== */
#route line {
  stroke: #22c55e;
  stroke-width: 8;
  stroke-linecap: round;
  stroke-dasharray: 10 6;
  animation: dash 1s linear infinite;
  opacity: 0.9;
}

@keyframes dash {
  to {
    stroke-dashoffset: -16;
  }
}

/* =====================
   MAP CONTROLS
===================== */
#map-controls button {
  width: 36px;
  height: 36px;
  border-radius: 8px;
  border: 1px solid #1f2937;
  background: #fdfdfd;
  color: #051d4c;
  transition: background 0.15s ease, transform 0.15s ease;
}

#map-controls button:hover {
  background: #636c7e;
  transform: translateY(-1px);
}

#map-controls button:active {
  transform: translateY(0);
}
#atlas-container,
#map-wrapper,
#atlas-svg {
    background: #0b1220;
}

</style>
<div id="bg-grid"></div>
<div class="post-card">
    <div class="card shadow-sm mb-4">
        <div class="card-body p-3">
            <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between mb-3">
                <div>
                    <h1 class="h4 mb-0">Manila MRT/LRT Network</h1>
                    <p class="text-muted mb-0">Find the fastest route between stations</p>
                </div>
                <div class="mt-3 mt-md-0">
                </div>
            </div>

            <div class="row g-3 align-items-end">
                <div class="col-md-5">
                    <label for="from-station" class="form-label">From Station</label>
                    <select class="form-select" id="from-station">
                        <option value="">Select departure station</option>
                    </select>
                </div>
                <div class="col-md-5">
                    <label for="to-station" class="form-label">To Station</label>
                    <select class="form-select" id="to-station">
                        <option value="">Select destination station</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button id="find-route" class="btn btn-primary w-100" disabled>
                        <i class="bi bi-geo-alt me-1"></i> Find Route
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow-sm mb-4">
        <div id="atlas-container" style="position: relative; min-height: 600px; background-color: #0b1220; overflow: hidden; border-radius: 8px; border: 1px solid #0b1220;">
            <div id="map-controls" style="position: absolute; top: 15px; right: 15px; z-index: 100; display: flex; flex-direction: column; gap: 8px;">
                <button id="zoom-in" class="btn btn-light btn-sm shadow-sm" title="Zoom In">
                    <i class="bi bi-plus"></i>
                </button>
                <button id="zoom-out" class="btn btn-light btn-sm shadow-sm" title="Zoom Out">
                    <i class="bi bi-dash"></i>
                </button>
                <button id="reset-view" class="btn btn-light btn-sm shadow-sm" title="Reset View">
                    <i class="bi bi-arrow-counterclockwise"></i>
                </button>
            </div>
            <div id="loading" class="d-flex justify-content-center align-items-center" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(9, 2, 23, 0.9); z-index: 10; border-radius: 8px;">
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading map...</p>
                </div>
            </div>
            <div id="map-wrapper" style="width: 100%; height: 600px; overflow: hidden; position: relative;">
                <div id="atlas-svg" style="width: 100%; height: 100%; transform-origin: 0 0; transition: transform 0.2s ease-out;">
  <svg id="diagram-svg" width="6400" height="6000"
       style="background:#0a0e17; border-radius:8px;">
  </svg>
</div>

            </div>
        </div>
    </div>

    <div id="route-results" class="card shadow-sm" style="display: none;">
        <div class="card-body">
            <h5 class="card-title mb-3">Route Information</h5>
            <div class="row g-4 text-center">
                <div class="col-md-4">
                    <div class="p-3 bg-light rounded">
                        <h3 class="text-primary mb-1" id="travel-time">-</h3>
                        <p class="text-muted mb-0">Travel Time (min)</p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="p-3 bg-light rounded">
                        <h3 class="text-primary mb-1" id="distance">-</h3>
                        <p class="text-muted mb-0">Distance (meters)</p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="p-3 bg-light rounded">
                        <h3 class="text-primary mb-1" id="stops">-</h3>
                        <p class="text-muted mb-0">Stops</p>
                    </div>
                </div>
            </div>
            <div class="mt-4">
                <h6 class="mb-3">Route Details:</h6>
                <div class="p-3 bg-light rounded" id="route-path">
                    Select stations to find a route
                </div>
            </div>
        </div>
    </div>
</div>



<script>
/* =========================
   GLOBALS
========================= */
let stations = [];
const svgEl = document.getElementById('atlas-svg');
const fromSelect = document.getElementById('from-station');
const toSelect = document.getElementById('to-station');
const findRouteBtn = document.getElementById('find-route');
const routeResults = document.getElementById('route-results');
const travelTimeEl = document.getElementById('travel-time');
const distanceEl = document.getElementById('distance');
const stopsEl = document.getElementById('stops');
const routePathEl = document.getElementById('route-path');
const loadingEl = document.getElementById('loading');

/* =========================
   SVG LOAD
========================= */
function resetView() {
    scale = 3.45;   // default zoom-in
    posX = -330;
    posY = 100;
    updateTransform();
}

async function loadSVG(path = null) {
    try {
        showLoading();

        const url = path
            ? `/atlas/svg?path=${encodeURIComponent(JSON.stringify(path))}`
            : `/atlas/svg`;

        const response = await fetch(url);
        const svgContent = await response.text();

        // Inject SVG
        svgEl.innerHTML = svgContent;
        resetView();          

        // Extract + UI
        extractStations();
        populateDropdowns();
        setupEventListeners();

    } catch (err) {
        console.error(err);
        showError('Error loading map.');
    } finally {
        hideLoading();
    }
}


function extractStations() {
    stations = Array.from(svgEl.querySelectorAll('.station'))
        .map(el => el.getAttribute('data-station'))
        .filter(Boolean);
}

/* =========================
   SMART LAYOUT (THE FIX)
========================= */
function applySmartLayout() {
    const stations = Array.from(svgEl.querySelectorAll('.station'))
        .map(st => {
            const name = st.getAttribute('data-station');
            const cx = +st.getAttribute('cx');
            const cy = +st.getAttribute('cy');
            const label = svgEl.querySelector(`text[data-station="${name}"]`);
            return { st, name, cx, cy, label };
        })
        .filter(s => s.label)
        .sort((a, b) => a.cx - b.cx); // IMPORTANT: left â†’ right

    const OFFSET = 22;
    let lastTopEndX = -Infinity;
    let lastBottomEndX = -Infinity;

    stations.forEach(s => {
        const { cx, cy, label } = s;

        label.setAttribute('x', cx);
        label.setAttribute('text-anchor', 'middle');

        // force browser to compute size
        const bbox = label.getBBox();
        const startX = cx - bbox.width / 2;
        const endX = cx + bbox.width / 2;

        let y, lane;

        if (startX > lastTopEndX) {
            // TOP lane free
            y = cy - OFFSET;
            lastTopEndX = endX;
            lane = 'top';
        } else {
            // push to bottom
            y = cy + OFFSET;
            lastBottomEndX = endX;
            lane = 'bottom';
        }

        label.setAttribute('y', y);
        label.setAttribute(
            'dominant-baseline',
            lane === 'top' ? 'auto' : 'hanging'
        );
    });
}


/* =========================
   UI HELPERS
========================= */
function showLoading() {
    loadingEl.style.display = 'flex';
}
function hideLoading() {
    loadingEl.style.display = 'none';
}
function showError(msg) {
    svgEl.innerHTML = `<div class="alert alert-danger m-3">${msg}</div>`;
}

/* =========================
   DROPDOWNS
========================= */
function populateDropdowns() {
    const options = stations.map(s => `<option value="${s}">${s}</option>`).join('');
    fromSelect.innerHTML = '<option value="">From</option>' + options;
    toSelect.innerHTML = '<option value="">To</option>' + options;
}

/* =========================
   EVENTS
========================= */
function setupEventListeners() {
    [fromSelect, toSelect].forEach(sel =>
        sel.addEventListener('change', updateButtonState)
    );

    findRouteBtn.addEventListener('click', findRoute);
    svgEl.addEventListener('click', handleStationClick);
}

function handleStationClick(e) {
    const stationEl = e.target.closest('.station');
    if (!stationEl) return;

    const name = stationEl.getAttribute('data-station');
    if (!name) return;

    if (!fromSelect.value) fromSelect.value = name;
    else if (!toSelect.value) toSelect.value = name;
    else {
        fromSelect.value = toSelect.value;
        toSelect.value = name;
    }

    updateButtonState();
    findRoute();
}

function updateButtonState() {
    findRouteBtn.disabled = !(fromSelect.value && toSelect.value);
}

/* =========================
   ROUTING
========================= */
async function findRoute() {
    const from = fromSelect.value;
    const to = toSelect.value;
    if (!from || !to) return;

    try {
        showLoading();
        findRouteBtn.disabled = true;

        const res = await fetch('/atlas/route', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ src: from, dst: to })
        });

        const data = await res.json();
        displayRouteResults(data);

    } catch (e) {
        console.error(e);
        showError('Route error');
    } finally {
        findRouteBtn.disabled = false;
        hideLoading();
    }
}

function displayRouteResults(data) {
    if (!data.path?.length) {
        showError('No route found.');
        return;
    }

    travelTimeEl.textContent = data.minutes || '0';
    distanceEl.textContent = data.meters || '0';
    stopsEl.textContent = data.path.length - 1;
    routePathEl.textContent = data.path.join(' â†’ ');

    routeResults.style.display = 'block';
    highlightPath(data.path);
}

function highlightPath(path) {
    loadSVG(path); // ðŸ”¥ reload SVG then re-layout
}

/* =========================
   ZOOM / PAN (UNCHANGED)
========================= */
let scale = 6400, posX = 50, posY = 50;
let isDragging = false, startX, startY, startPosX, startPosY;

function updateTransform() {
    svgEl.style.transform = `translate(${posX}px, ${posY}px) scale(${scale})`;
}

function handleWheel(e) {
    e.preventDefault();
    const delta = -Math.sign(e.deltaY) * 0.1;
    scale = Math.min(Math.max(0.5, scale + delta), 3);
    updateTransform();
}

function startDrag(e) {
    isDragging = true;
    startX = e.clientX;
    startY = e.clientY;
    startPosX = posX;
    startPosY = posY;
}

function drag(e) {
    if (!isDragging) return;
    posX = startPosX + (e.clientX - startX);
    posY = startPosY + (e.clientY - startY);
    updateTransform();
}

function endDrag() {
    isDragging = false;
}

/* =========================
   INIT
========================= */
document.addEventListener('DOMContentLoaded', () => {
    const mapWrapper = document.getElementById('map-wrapper');
    mapWrapper.addEventListener('wheel', handleWheel, { passive: false });
    mapWrapper.addEventListener('mousedown', startDrag);
    document.addEventListener('mousemove', drag);
    document.addEventListener('mouseup', endDrag);
    document.addEventListener('mouseleave', endDrag);

    document.getElementById('zoom-in').onclick = () => {
        scale = Math.min(scale + 0.2, 3); updateTransform();
    };
    document.getElementById('zoom-out').onclick = () => {
        scale = Math.max(scale - 0.2, 0.5); updateTransform();
    };
    document.getElementById('reset-view').onclick = () => {
        scale = 1; posX = 0; posY = 0; updateTransform();
    };

    loadSVG();
});
</script>

{% endblock %}